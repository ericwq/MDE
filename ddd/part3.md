## 第三部分：重构以获得更深层的洞察

#### ▶[上一节](ch7/12.md)

本书 [第二部分](part2.md) 为保持模型与实现之间的对应关系奠定了基础。采用一套经过验证的基本构建模块并使用统一的语言，使开发工作恢复了一些理性。

当然，真正的挑战在于 *找到* 一个真正精辟的模型，既能捕捉领域专家的微妙考量，又能推动实际设计。最终，我们期望构建出能深刻理解领域本质的模型。这将使软件更契合领域专家的思维方式，更敏锐地响应用户需求。本书此部分将阐明该目标，描述实现路径，并阐释若干设计原则与模式，这些方法既能满足应用需求，也能适应开发者自身的工作模式。

开发出有用的模型取决于以下三点：
1. 精妙的领域模型是可实现的，且值得付出努力。
2. 它们通常需要通过反复重构的过程才能开发出来，这包括领域专家与有兴趣了解该领域的开发人员密切合作。
3. 它们可能需要精湛的设计技能才能有效实现和使用。

### 重构层次

重构是指在不改变软件功能的前提下对其进行重新设计。开发者无需预先制定复杂的设计方案，而是通过持续进行一系列细微且独立的设计调整，每次修改都保持现有功能不变，同时使设计更具灵活性或更易理解。一套自动化的单元测试可确保对代码进行相对安全的实验。该过程使开发者无需过度预判未来需求。

然而，几乎所有关于重构的文献都聚焦于代码的机械性修改，旨在提升可读性或在极细微层面增强代码。当开发者发现应用成熟设计模式的机会时，“refactoring to patterns” <sup>[1](#1)</sup> 的方法能为重构过程提供更高层次的目标。但这种方法本质上仍是从技术角度审视设计质量。

对系统可行性影响最大的重构，是那些源于对领域的新洞见，或是通过代码清晰表达模型本质的重构。此类重构绝非取代设计模式重构或微重构，后者应持续进行，而是叠加了更高层次的操作：向更深层模型进行重构。基于领域洞察的重构往往包含一系列微重构，但其动机并非仅源于代码现状。这些微重构实为通向更具洞察力模型的便捷变更单元。其目标不仅在于让开发者理解代码功能，更要使其洞悉实现原理，并能将此理解融入与领域专家的持续沟通中。

《Refactoring》（ [Fowler 1999](references.md#fowler-1999)）中的目录涵盖了绝大多数常见的微重构操作。每项操作主要源于代码本身可观察到的问题。相比之下，随着新见解的涌现，领域模型会以多种方式发生转变，因此根本不可能编纂出全面的目录。

建模与任何探索活动一样，本质上都是非结构化的。当学习和深度思考引领我们走向更深层的洞察时，就应当进行重构。正如 [第 11 章](ch10/0.md) 所述，已发布的成功模型集确实有所助益，但我们不应偏离正轨，试图将领域建模简化为食谱或工具包。建模与设计需要创造力。接下来的六章将提出若干具体方法，用于思考如何改进领域模型，并通过设计使其真正落地生根。

### 深度模型

传统对象分析方法通常涉及识别需求文档中的名词和动词，并将其作为初始对象和方法。这种解释被认为过于简化，但对于向初学者传授对象建模知识仍具实用价值。然而事实是，初始模型往往基于浅层认知，显得天真且肤浅。

例如，我曾参与开发一个航运应用程序，最初构思的对象模型包含船舶和集装箱。船舶在不同地点间移动，集装箱通过装卸操作实现关联与分离。这种模型准确描述了某些物理运输活动，但对于航运业务软件而言却并非实用模型。

经过数月与航运专家反复推敲，我们最终演变出截然不同的模型。它对非专业人士而言或许不够直观，却更能契合专家需求。该模型重新聚焦于货物运输的核心业务。

船舶依然存在，但已抽象为 “船舶航次” 的形式 —— 即为船舶、火车或其他运输工具安排的特定行程。船舶本身成为次要元素，可在最后时刻因维护或时间表延误而替换，而船舶航次仍按计划进行。集装箱在模型中几近消失。它确实以另一种极其复杂的形式出现在货物处理应用中，但在原始应用场景下，集装箱仅是操作层面的细节。货物的物理移动让位于货物法律责任的转移，诸如 “提单” 这类更隐蔽的对象反而凸显出来。

每当有新的对象建模师加入项目时，他们的首要建议是什么？缺失的类：船只和集装箱。他们都是聪明人，只是尚未经历过发现的过程。

*深度模型清晰地表达了领域专家的核心关切及其最相关的知识，同时剔除了领域的表层内容。* 这一定义未提及抽象概念。深度模型通常包含抽象元素，但若涉及问题的核心，它也可能包含具体元素。

多功能性、简洁性和解释力源于真正契合领域特征的模型。这类模型几乎都具备一个共同特征：采用业务专家偏爱的简单语言，尽管这种语言可能较为抽象。

### 深度模型/灵活设计

在持续重构的过程中，设计本身需要支持变更。[第 10 章](ch10/0.md) 探讨了如何使设计易于操作，既便于修改者进行变更，也便于集成者将其与系统其他部分整合。

设计中某些特性使其更易于变更和使用。这些特性虽不复杂，却颇具挑战性。[第 10 章](ch10/0.md) 将探讨 “灵活设计” 及其实现方法。

幸运的是，当每次变更都反映出新的理解时，反复改造模型和代码的行为本身，恰恰能在最需要改变的环节带来灵活性，同时为常规操作提供便捷途径。就像戴久了的手套，手指弯曲处变得柔软，其他部位却依然坚固防护。因此尽管这种建模设计方法需要大量试错，但修改过程反而会变得更轻松，而反复调整最终将引领我们走向灵活的设计。


除了促进变更外，灵活的设计还有助于完善模型本身。[MODEL-DRIVEN DESIGN](../glossary.md#model-driven-design) 立足于双重支撑：深度模型赋予设计表达力。而设计则能反哺模型探索过程，当它具备灵活性允许开发者实验，同时能清晰呈现运行状态。这种反馈机制至关重要，因为我们追寻的模型不仅是理想构想的集合，更是系统运行的根基。

### 发现过程

要创造真正契合当前问题的设计，首先必须建立一个能够捕捉领域核心相关概念的模型。主动探索这些概念并将其融入设计的过程，正是 [第 9 章](ch9/0.md) "将隐含概念显性化" 的主题所在。

由于模型与设计之间存在紧密联系，当代码难以重构时，建模过程便会陷入停滞。[第 10 章](ch10/0.md) "灵活设计" 探讨了如何为软件开发者（包括你自己）编写软件，使其在扩展和变更时保持高效。这项工作与模型的进一步完善相辅相成，通常需要运用更先进的设计技术，并对模型定义进行更严格的规范。

通常你需要依靠创造力和反复尝试来找到建模方法，将发现的概念转化为模型。但有时前人已为你铺就了可循的模式。[第 11 章](ch11/0.md) 和 [第 12 章](ch12/0.md) 将探讨 “分析模式” 与 “设计模式” 的应用。这些模式并非现成的解决方案，而是为你的知识消化过程提供养分，并能有效缩小探索范围。

但 [第三部分](part3.md) 将从领域驱动设计中最激动人心的事件开始。当模型驱动设计与明确概念共同构筑好舞台时，突破性时刻便会降临。此时便会涌现机遇，将软件蜕变为比预期更具表现力与灵活性的存在。这既可能催生新功能，也可能仅需用更深层模型的简洁表达，替换掉大量僵化的代码。尽管此类突破并非朝夕可得，但其价值之珍贵，在于当机遇降临时，必须敏锐捕捉并全力把握。

[第 8 章](ch8/0.md) 讲述了一个真实案例：某个项目在追求更深层次洞察的过程中，通过重构实现了突破性进展。这种体验并非可预先规划之事，但它为思考领域重构提供了绝佳的思考背景。

#### ▶[下一节](ch8/0.md)

---
#### 1
[Gamma et al. 1995](references.md#gamma-1995) 曾简要提及将模式作为重构目标。Joshua Kerievsky 将模式重构发展为更成熟且实用的形式（ [Kerievsky 2003](references.md#kerievsky-2003) ）。
